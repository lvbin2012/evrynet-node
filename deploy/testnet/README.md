# How to use Testsnet Docker   

## 1. Preparing Images 
### Building images
First of all, you need to change the `login` & `password` (is your token) at file `deploy/testnet/builder/token` to yours. You can get a token from [Here](https://github.com/settings/tokens).

You use this file `deploy/testnet/build_images_for_bootnode_node_explorer.sh` with appropriate params to build images for bootnode, node & explorer.  

```shell script
$ deploy/testnet/build_images_for_bootnode_node_explorer.sh
- Tag Version/Branch Name you want to build: develop   (specific tag or branch you want to build (1.1.2, develop ...))
- Environment of Image: testnet                        (use as a suffix of image tag (testnet, local, ...))
- Do you want to build Explorer Image? y               (build an explorer image or not (y,n))
```



After building successfully, you can check the images by command `docker images`. The result should be like this:
```
REPOSITORY                      TAG                 IMAGE ID            CREATED             SIZE
kybernetwork/evrynet-node       develop-testnet     96b4226f096f        6 hours ago         85.2MB
kybernetwork/evrynet-bootnode   develop-testnet     1f48c40245c7        6 hours ago         35.1MB
kybernetwork/evrynet-builder    develop-testnet     b5b539596145        6 hours ago         1.08GB
...
```

### Pushing images to Docker Hub
If you want to reuse built images, you should push them to docker hub. If there is no such requirement, ignore this step.

Make sure you already login to the docker hub by `docker login`.  
Use `docker push <REPOSITORY>:<TAG>` to push the image to Docker Hub.  

Ex:
```
docker push kybernetwork/evrynet-node:develop-testnet
docker push kybernetwork/evrynet-bootnode:develop-testnet
docker push kybernetwork/evrynet-explorer:develop-testnet
```


## 2. Deployment
### 2.1. Using Quickstart With Predefined Config
#### Run Testnet Docker with 3 nodes and the explorer on a single machine

This setup contains a system of 3 Evrynet nodes configured to run Tendermint consensus. The set of addresses for these nodes as well as Tendermint consensus is supposed to be generated by `puppeth`. For a deeper understanding of how to generate this file, please go through [genesis file wiki](https://github.com/Evrynetlabs/evrynet-node/wiki/Genesis-file).  

Run this interactive shell `deploy/testnet/deploy_bootnode_nodes.sh`, it will require you mandatory input params:    
- `Path of Sharing Volume`: the path to nodes folder. On Testnet is `/home/ubuntu/testnet/nodes`
- `Path of Genesis File`: inject genesis file to the image
-` RPC Cors Domain`: allow URL can call API
- `Tag Version/Branch Name you want to deploy`: a specific tag or branch you want to build (1.1.2, develop ...))
- `Environment of Image`: use as a suffix of image tag (testnet, local, ...)

Ex:
```shell script
ubuntu@dev-evrynet-testnet:~/evrynet-node$ deploy/testnet/deploy_bootnode_nodes.sh
- Path of Sharing Volume: /home/ubuntu/testnet/nodes
- Path of Genesis File: /home/ubuntu/testnet/nodes/genesis.json
- RPC Cors Domain: *
- Tag Version/Branch Name you want to deploy: develop
- Environment of Image: testnet
```

To deploy the explorer run this interactive shell `deploy/testnet/deploy_explorer.sh`, it will require you mandatory input params:  
- `Tag Version/Branch Name you want to deploy`: specific tag or branch you want to build (1.1.2, develop ...)
- `Environment of Image`: use as a suffix of image tag (testnet, local, ...)

Ex:
```shell script
ubuntu@dev-evrynet-testnet:~/evrynet-node$ deploy/testnet/deploy_explorer.sh
- Tag Version/Branch Name you want to deploy: develop
- Environment of Image: testnet
```

#### Nodes Information
Nodes data is stored at `deploy/testnet/nodes/data`.  
The data can be cleared using the following script `deploy/testnet/nodes/data/clear_data.sh`

### Webs
- Explorer: http://localhost:8080

#### NOTICE!
- If you want to stop nodes, DON'T USE `docker stop ...`. It can make a crash to DB of nodes => can not run for next time!
- To stop nodes gracefully, USE this file `deploy/testnet/stop_dockers.sh`. It will interact with the node in docker to stop gracefully.

---

### 2.2. Setup From Zero 
This guide will demonstrate the process of setting up 3 nodes manually in the same machine. The process will including: 
 - Build the executable from source code
 - Create a working directory for the node data
 - Generate node's key (for consensus message signing)
 - Generate enodes address (for node connections)
 - Deploy
 
The bellow example explains how to deploy 3 nodes manually.

1. Build and export to `PATH`. Make sure you already have golang 1.12 or later installed.
    ```shell script
    $ go build ./cmd/gev
    $ go build ./cmd/bootnode
    $ go build ./cmd/puppeth
    $ export PATH=$(pwd):$PATH
    ```
2. Move to folder where you want to store nodes data. Creating a working directory for 3 validator nodes  
    ```shell script
    $ mkdir -p nodes/node_1 nodes/node_2 nodes/node_3
    ```  

3. In each node's working directory, create a log & data directory called `data`, and inside `data` create the `geth` directory   
    ```shell script
    $ mkdir -p nodes/node_1/log
    $ mkdir -p nodes/node_2/log
    $ mkdir -p nodes/node_3/log
    $ mkdir -p nodes/node_1/data/geth
    $ mkdir -p nodes/node_2/data/geth
    $ mkdir -p nodes/node_3/data/geth
    ```

4. Generate node key and copy it into folder `node_1`, `node_2` `node_3`
    ```shell script
    $ bootnode --genkey=nodekey1
    $ bootnode --genkey=nodekey2
    $ bootnode --genkey=nodekey3
    $ cp nodekey1 nodes/node_1/data/geth/nodekey
    $ cp nodekey2 nodes/node_2/data/geth/nodekey
    $ cp nodekey3 nodes/node_3/data/geth/nodekey
    ```
  
 5. Now we will get the address for 3 nodes. Using the content of nodekey1,2,3 files (Ex: `node_1/data/geth/nodekey`) as Private Key to get Address of each nodes at [myetherwallet](myetherwallet.com) 
 6. The last step, we need to create new `genesis.json` using the new address of validators.  
 Run `puppeth` and full fill data of your chain. Using 3 Addresses we just get from 3 Private Keys above.   
 More information on Genesis file can be viewed at [genesis file wiki](https://github.com/Evrynetlabs/evrynet-node/wiki/Genesis-file).  
    ```shell script
    ❯ ./puppeth
    +-----------------------------------------------------------+
    | Welcome to puppeth, your Evrynet private network manager |
    |                                                           |
    | This tool lets you create a new Evrynet network down to  |
    | the genesis block, bootnodes, miners and ethstats servers |
    | without the hassle that it would normally entail.         |
    |                                                           |
    | Puppeth uses SSH to dial in to remote servers, and builds |
    | its network components out of Docker containers using the |
    | docker-compose toolset.                                   |
    +-----------------------------------------------------------+
    
    Please specify a network name to administer (no spaces, hyphens or capital letters please)
    > testnet
    
    Sweet, you can set this via --network=testnet next time!
    
    INFO [03-16|13:19:01.412] Administering Evrynet network            name=testnet
    WARN [03-16|13:19:01.414] No previous configurations found         path=/Users/nmhoang/.puppeth/testnet
    
    What would you like to do? (default = stats)
     1. Show network stats
     2. Configure new genesis
     3. Track new remote server
     4. Deploy network components
    > 2
    
    What would you like to do? (default = create)
     1. Create new genesis from scratch
     2. Import already existing genesis
    > 1
    
    Which consensus engine to use? (default = clique)
     1. Ethash - proof-of-work
     2. Clique - proof-of-authority
     3. Tendermint - practical-byzantine-fault-tolerance
    > 3
    What is poclicy to select proposer (default 0 - roundrobin)
    > 0
    
    Which accounts are validators? (mandatory at least one)
    > 0x560089aB68dc224b250f9588b3DB540D87A66b7a
    > 0x954e4BF2C68F13D97C45db0e02645D145dB6911f
    > 0x45F8B547A7f16730c0C8961A21b56c31d84DdB49
    >
    
    Do you want to use fixed validators? (default = no)
    > no
    
    Do you want to use precompiled Staking Smart Contract file? (default =yes)
    > yes
    Specify your Bytecode file path (default = ./consensus/staking_contracts/EvrynetStaking.bin/EvrynetStaking.bin)
    >
    Specify your ABI path (default = ./consensus/staking_contracts/EvrynetStaking.bin/EvrynetStaking.abi)
    >
    
    Input params to init staking SC:
    - What is the address of candidates owner? (expected 3 address)
    > 0x560089aB68dc224b250f9588b3DB540D87A66b7a
    > 0x954e4BF2C68F13D97C45db0e02645D145dB6911f
    > 0x45F8B547A7f16730c0C8961A21b56c31d84DdB49
    >
    - What is the admin address of staking SC?
    > 0x94F5B16552DCEaCbAdABA146D6e3235f4A8617a8
    - How many blocks for epoch period? (default = 1024)
    > 40
    - What is the max size of validators? (max number of candidates to be selected as validators for producing blocks)
    > 1000
    - What is the min stake of validator? (minimum (his own) stake of each candidate to become a validator (use to slash if validator is doing malicious things))
    > 1
    - What is the min cap of vote? (minimum amount of EVR tokens to vote for a candidate)
    > 1
    
    What is the address of staking smart contract? (avoid special address from 0x0000000000000000000000000000000000000001 to 0x0000000000000000000000000000000000000008)
    > 0x2D5Bd25EfA0aB97aaca4E888c5fbCB4866904E46
    INFO [03-16|13:20:30.546] Persisted trie from memory database      nodes=1 size=150.00B time=13.189µs gcnodes=0 gcsize=0.00B gctime=0s livenodes=1 livesize=0.00B
    INFO [03-16|13:20:30.558] Loaded most recent local header          number=0 hash=9e540f…644118 td=0 age=50y11mo1w
    INFO [03-16|13:20:30.558] Loaded most recent local full block      number=0 hash=9e540f…644118 td=0 age=50y11mo1w
    INFO [03-16|13:20:30.558] Loaded most recent local fast block      number=0 hash=9e540f…644118 td=0 age=50y11mo1w
    INFO [03-16|13:20:30.558] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.559] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.559] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.560] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.560] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.560] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.561] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.561] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.561] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.562] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.562] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.562] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.563] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.563] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.564] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.564] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.564] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.565] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.565] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.565] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.566] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.566] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.597] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.597] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.598] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.598] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.598] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.599] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.599] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.600] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.601] got optional parameters, take only the first Option, ignore the rest opts="[{OwnerAddress:<nil> ProviderAddress:<nil>}]"
    INFO [03-16|13:20:30.602] Imported new chain segment               blocks=1 txs=1 mgas=2.736 elapsed=1.065ms mgasps=2568.684 number=1 hash=b44251…a6e384 age=50y11mo1w dirty=15.84KiB
    
    Do you want to create accounts for tx flood? (default = no)
    > no
    
    Which accounts should be pre-funded? (advisable at least one)
    >
    
    Should the precompile-addresses (0x1 .. 0xff) be pre-funded with 1 wei? (advisable no)
    >
    
    Specify your chain/network ID if you want an explicit one (default = random)
    > 15
    INFO [03-16|13:20:40.063] Configured new genesis block
    
    What would you like to do? (default = stats)
     1. Show network stats
     2. Manage existing genesis
     3. Track new remote server
     4. Deploy network components
    > 2
    
     1. Modify existing fork rules
     2. Export genesis configurations
     3. Remove genesis configuration
    > 2
    
    Which folder to save the genesis specs into? (default = current)
      Will create testnet.json, testnet-aleth.json, testnet-harmony.json, testnet-parity.json
    >
    INFO [03-16|13:20:48.391] Saved native genesis chain spec          path=testnet.json
    ERROR[03-16|13:20:48.392] Failed to create Aleth chain spec        err="unsupported consensus engine"
    ERROR[03-16|13:20:48.392] Failed to create Parity chain spec       err="unsupported consensus engine"
    INFO [03-16|13:20:48.392] Saved genesis chain spec                 client=harmony path=testnet-harmony.json
    ```
7. Replace all content of `genesis.json` with `testnet.json` (new genesis file just created) by command:
    ```shell script
    $ cp testnet.json nodes/genesis.json
    ```

8. Run the deployment script or to run each node from executable:

To deploy using pre-written scripts:  
 Run this command `deploy/testnet/deploy_bootnode_nodes.sh` with the suitable params:
- `Path of Sharing Volume`: the path to nodes folder. On Testnet is `/home/ubuntu/testnet/nodes`
- `Path of Genesis File`: inject genesis file to the image
- `RPC Cors Domain`: allow URL can call API
- `Tag Version/Branch Name you want to deploy`: a specific tag or branch you want to build (1.1.2, develop ...))
- `Environment of Image`: use as a suffix of image tag (testnet, local, ...)

This command can use on Testnet server:
```shell script
ubuntu@dev-evrynet-testnet:~/evrynet-node$ deploy/testnet/deploy_bootnode_nodes.sh
- Path of Sharing Volume: /home/ubuntu/evrynet-node/nodes
- Path of Genesis File: /home/ubuntu/evrynet-node/nodes/genesis.json
- RPC Cors Domain: *
- Tag Version/Branch Name you want to deploy: develop
- Environment of Image: testnet
```  


 To deploy by running binary files:
- You must start the bootnode first to let nodes discover each other
```shell script
./bootnode -nodekeyhex "9dbcbd49f9f4e1b4949178d7e413142267050377ff99d81c08e371cdea712f09" -verbosity 9 -addr ":30300"
```
-nodekeyhex: you can get new value by command `./bootnode --genkey=nodekey`

- You must init data for the node first
```shell script
./gev --datadir ./data init ./deploy/testnet/nodes/bin/genesis.json
`"
--datadir: where you store node data

- Then start node by this command
```shell script
./gev --datadir ./data --verbosity 4 --tendermint.blockperiod 1 --syncmode full --networkid 15 \
    --rpc --rpcaddr 0.0.0.0 --rpccorsdomain "*" --rpcvhosts "*" --rpcport 22001 --port 30301 \
    --bootnodes "enode://aa8d839e6dbe3524e8c0a62aefae7cefa3880f9c7394ddaaa31cc8679fe3a25396e014c5c48814d0fe18d7f03d72a7971fd50b7dd689bd04498d98902dd0d82f@172.25.0.100:30300" \
    --allow-insecure-unlock \
    --rpcapi admin,db,eth,debug,miner,net,shh,txpool,personal,web3 2>>./log/node_1.log
```
--bootnodes: you will see this value when you start bootnode. Change `172.25.0.100` to IP of bootnode server

- To run another node, you can reuse the above command. You must change the value of params `rpcport, port` and `node_1.log`
